#include <stdio.h>
#include <stdlib.h>
#include "math.h"

#define N 16 // Number of data points
#define B 2 // Number of bins
#define L (N / B) //(N / B) // Number of data points per bin
#define P 3   // Number of top peaks to select
#define THRESHOLD 0.1 // Threshold for peak significance

void Bin_Based_Accel() {
    double rawSignal[N] = { 32.764,-3.659,-0.498,5.114,0.153,-3.825,3.722,1.548,0.207,-1.781,2.101,2.306,-0.888,-0.254,0.95,-0.768};

    //double rawSignal[N] = { 32.764,-3.659,-0.498,5.114,0.153,-3.825,3.722,1.548,0.207,-1.781,2.101,2.306,-0.888,-0.254,0.95,-0.768,-0.824,3.571,-0.055,-2.86,2.04,1.732,-1.348,2.306,0.31,-1.808,-0.375,-1.192,1.171,2.217,0.991,0.132,1.201,0.285,4.137,10.506,-2.424,-9.848,2.59,1.937,-3.683,2.966,4.916,-1.423,-1.486,2.341,0.972,-2.415,-0.362,2.073,-0.608,0.488,3.356,0.34,-1.922,1.713,2.453,-0.932,0.049,0.916,0.196,0.811,1.008,-0.261,-0.178,0.619,0.88,0.474,-0.158,0.703,1.094,0.279,-0.283,0.758,1.065,-0.162,0.606,0.81,-0.387,0.142,1.709,1.036,1.063,1.156,0.495,0.267,0.417,0.416,-0.34,-0.355,0.177,0.292,0.2,1.436,1.2,0.296,0.246,0.365,0.552,-0.099,0.539,0.966,0.186,0.914,-0.114,-1.905,-0.164,0.73,-0.28,-0.01,0.53,3.226,3.564,1.048,0.31,1.843,0.347,0.367,1.772,1.493,1.095,0.079,0.811,0.637,-0.332,0.283,0.79,0.682,-0.04,0.263,0.728,-0.088,0.069,0.653,0.121,0.311,1.093,0.938,-0.465,-0.309,-0.395,-0.487,0.778,0.87,0.448,0.182,0.45,0.551,-0.583,0.412,0.541,-0.358,1.074,1.438,0.775,0.679,0.54,0.355,0.675,0.115,0.157,0.719,0.798,0.93,0.878,0.477,0.059,0.84,1.143,1.002,1.082,1.301,1.358,0.639,1.353,1.354,0.11,0.542,1.18,0.914,0.3,-0.134,0.515,0.285,0.286,0.4,0.431,0.508,0.287,0.492,0.08,0.526,-0.1,-0.259,0.965,0.552,-0.591,-0.288,0.683,0.488,-0.149,-0.085,0.39,0.273,0.231,0.486,0.708,0.134,0.021,0.617,0.319,0.81,0.569,-0.006,1.036,0.452,-0.09,0.388,0.792,0.708,1.597,1.546,-0.036,0.734,1.678,0.335,1.345,1.822,0.648,0.53,1.356,1.145,1.144,1.127,0.512,0.213,0.763,1.048,-0.118,0.202,0.953,0.428,0.034,0.539,-0.009,-0.157,0.801,0.45,0.556,0.321,0.339,0.22,-0.026,-0.517,0.171,0.955,-0.098,-0.192,0.233,0.177,0.185,-0.02,0.072,0.783,0.266,0.627,0.554,0.254,0.431,0.366,0.201,0.718,1.381,-0.042,-0.081,1.382,0.973,0.925,0.822,1,1.11,1.436,0.687,1.069,1.755,0.697,0.926,0.596,0.243,0.94,1.116,0.405,1.044,0.892,0.355,0.01,0.677,0.565,-0.052,0.439,1.332,0.323,-0.004,0.91,0.299,-0.762,-0.112,0.369,0.382,-0.004,0.316,0.335,0.415,0.316,0.017,0.183,0.527,0.054,0.177,0.705,0.333,0.294,0.336,0.149,0.199,0.326,0.426,0.693,0.772,0.29,0.625,0.838,0.602,1.245,0.988,0.883,1.579,1.216,0.813,0.694,0.286,0.669,0.892,0.28,0.929,1.224,0.571,0.567,0.676,0.356,0.124,0.22,0.628,0.646,0.733,0.622,0.174,0.131,0.388,0.051,0.295,0.514,-0.02,0.182,0.722,0.504,0.264,0.144,0.346,0.107,0.071,0.443,0.474,0.628,0.695,0.417,0.082,0.191,0.126,0.055,1.116,0.368,0.622,0.725,0.786,0.828,0.559,0.576,0.702,1.378,1.203,0.882,0.881,0.901,0.827,0.384,0.62,0.775,0.294,0.72,0.606,0.503,1.054,0.642,0.263,0.505,0.477,0.002,0.579,0.412,0.387,0.182,0.299,0.193,0.404,0.294,0.234,0.524,0.817,0.246,0.406,0.664,-0.092,0.144,0.797,0.558,0.533,0.227,0.18,-0.106,0.289,0.775,0.566,0.535,0.8,0.363,0.542,0.744,0.834,0.685,0.507,1.024,1.069,0.589,0.976,0.775,0.927,0.738,0.625,1.088,0.992,0.166,0.526,0.719,0.376,0.437,1.185,0.327,0.427,0.571,0.278,0.078,0.675,-0.044,0.254,0.792,0.29,0.407,0.32,0.234,0.242,0.744,0.097,0.361,0.58,0.517,0.194,0.214,0.64,0.708,0.14,0.573,0.656,-0.249,0.712,0.776,0.428,0.624,0.159,0.382,0.962,0.164,0.568,0.726,1.215,0.709,0.458,1.15,0.593,0.611,1.379,0.638,0.629,0.721,0.805,0.539,0.634,0.539,0.636,0.596,0.69,0.114,0.195,0.632,0.517,0.26,0.02,0.307,0.186,0.71,0.652,0.262,0.616,0.441,0.245,0.49,0.597,0.258,0.697,0.712,0.415,0.008,0.593,0.63,0,0.867,0.959,0.127,0.389,0.822,0.359,0.43,0.498,0.708,0.695,0.324,0.849,0.847,0.454,0.332,0.773,0.58,0.65,0.851,0.689,0.684,0.798,0.678,0.815,0.399,0.243,0.748,0.59,0.423,0.529,0.442,0.146,0.527,0.051,0.198,0.421,0.508,0.679,-0.063,-0.967,0.638,0.573,0.072,1.114,1.019,0.383,0.381,0.551,0.752,0.416,0.254,0.503,0.417,0.669,0.803,0.646,0.895,0.774,0.297,0.756,0.687,0.237,0.647,0.516,0.842,0.872,0.194,0.359,0.666,0.805,0.632,0.764,0.946,0.682,0.58,0.325,0.777,0.618,0.452,0.468,0.566,0.567,0.242,0.434,0.502,0.176,-0.027,0.14,0.416,0.512,0.304,0.387,0.413,0.451,0.4,0.375,0.737,0.302,0.7,0.881,0.607,0.632,0.35,0.35,0.404,0.272,0.27,0.355,0.634,0.935,0.566,0.636,0.746,0.63,0.568,0.401,0.735,0.759,0.552,0.248,0.593,0.776,0.613,0.627,0.471,0.565,1.01,0.731,0.686,0.752,0.483,0.282,0.686,0.395,0.529,0.565,0.455,0.446,0.374,0.224,0.663,0.339,0.322,0.409,0.315,0.38,0.438,0.479,0.585,0.695,0.223,0.376,0.714,0.563,0.574,0.24,0.394,0.605,0.401,0.736,0.746,0.682,0.805,0.573,0.502,0.75,0.607,0.371,0.122,0.655,0.738,0.47,0.388,0.323,0.683,0.455,0.643,0.722,0.579,0.575,0.707,0.711,0.669,0.408,0.616,0.733,0.687,0.143,0.602,0.437,0.072,0.42,0.616,0.326,0.514,0.269,0.188,0.591,0.74,0.262,0.519,0.72,0.562,0.54,0.418,0.449,0.521,0.309,0.544,0.578,0.568,0.755,0.652,0.652,0.828,0.667,0.458,0.896,0.865,0.434,0.396,0.634,0.533,0.453,0.104,0.59,0.764,0.23,0.664,0.61,0.438,0.6,0.618,0.489,0.824,0.778,0.418,0.683,0.446,0.236,0.361,0.296,0.478,0.339,0.255,0.521,0.73,0.192,0.081,0.555,0.542,0.31,0.464,0.455,0.496,0.357,0.562,0.758,0.389,0.741,0.478,0.066,0.647,0.692,0.507,0.706,0.803,0.857,0.69,0.429,0.981,1.172,0.424,0.494,1.033,0.635,0.01,0.508,0.669,0.334,0.634,0.852,0.176,0.38,0.612,0.463,0.588,0.768,0.67,0.541,0.374,0.453,0.587,0.222,0.486,0.669,0.032,0.048,0.479,0.717,0.471,0.473,0.252,0.318,0.092,0.342,0.647,0.409,0.536,0.568,0.555,0.337,0.42,0.518,0.561,0.957,0.528,0.468,0.598,0.832,0.819,0.377,0.964,0.912,0.271,0.569,0.65,0.916,0.936,0.626,0.328,0.439,0.532,0.283,0.745,0.844,0.447,0.582,0.211,0.37,0.728,0.655,0.576,0.84,0.655,0.224,0.044,0.522,0.09,0.277,0.829,0.59,0.457,0.133,0.033,0.377,0.731,0.685,0.573,0.715,0.078,0.265,0.736,0.594,0.832,0.409,0.134,0.358,0.654,0.466,0.613,1.067,0.979,0.763,0.488,0.778,0.7,0.096,0.75,0.767,0.92,0.66,0.432,0.425,0.27,0.581,0.819,0.536,0.684,0.228,0.262,0.371,0.359,0.753,0.791,0.456,0.575,0.386,-0.171,0.503,0.587,0.24,0.431,0.714,0.283,0.024,0.22,0.66,0.668,0.436,0.726,0.438,0.021,0.601,0.733,0.505,0.658,0.684,0.501,0.184,0.205,0.776,0.796,0.941,0.993,0.48,1.317,0.556,-0.147,1.473,0.765,0.09,1.024,0.015,0.345,1.207,-3.042,-25.037,-4.055,4.15,1.98,5.498,2.569,2.935,0.232,1.627,2.018,-1.529,0.795,11.279,4.999,2.638,7.657,3.522,3.139,1.439,1.051,-0.026,-1.199,-0.514,-0.78,-0.624,-0.722,-0.175,1.108,2.426,2.286,2.114,1.892,2.076,0.896,0.331,-0.248,-0.653,-1.085,-0.913,-0.555,-0.409,-0.175,0.219,1.308,1.302,0.848,0.354,0.158,0.167,0.311,0.094,-0.016,0.151,0.368,0.53,0.537,0.6,0.799,0.846,0.782,0.704,0.626,0.699,0.741,0.633,0.663,0.675,0.751,0.851,0.641,0.477,0.536,0.731,0.924,0.958,0.884,0.793,0.859,0.87,0.938,0.952,0.882,0.821,0.74,0.803,0.841,0.834,0.839,0.895,0.969,0.967,0.77,0.616,0.694,0.801,0.875,0.728,0.668,0.664,0.693,0.646,0.719,1.008,1.102,0.823,0.584,0.546,0.641,0.686,0.662,0.52,0.556,0.671,0.737,0.716,0.733,0.614,0.582,0.561,0.459,-0.059,-0.882,-0.708,-0.206,0.088,0.128,0.23,0.286,0.46,0.591,0.633,0.309,-0.208,-0.313,0.052,0.639,0.907,0.772,0.356,0.244,0.209,0.201,0.401,0.471,0.386,0.279,0.155,-0.15,-0.138,0.246,0.245,-0.125,-0.034,0.332,0.38,0.269,0.353,0.361,0.35,0.417,0.474,0.437,0.367,0.46,0.534,0.472,0.586,0.663,0.646,0.696,0.586,0.683,0.639,0.642,0.621,0.558,0.577,0.516,0.451,0.445,0.501,0.491,0.462,0.447,0.561,0.753,0.749,0.741,0.769,0.735,0.671,0.788,0.687,0.529,0.63,0.55,0.482,0.524,0.511,0.519,0.606,0.561,0.648,0.642,0.623,0.608,0.594,0.723,0.639,0.563,0.709,0.637,0.466,0.586,0.516,0.488,0.497,0.573,0.44,0.586,0.619,0.464,0.559,0.484,0.4,0.578,0.473,0.509,0.595,0.625,0.63,0.594,0.78,0.3,0.736,0.458,0.587,0.576,0.568,0.91,0.657,0.925,0.609,0.72,0.752,0.692,0.593,1.027,0.946,1.569,1.175,1.439,1.206,0.681,0.645,0.717,0.49,0.825,0.247,0.653,0.154,0.649,0.477,0.137,0.352,0.175,0.368,0.128,0.205,0.313,-0.068,0.534,0.252,0.119,0.096,0.226,0.007,0.346,0.275,0.178,0.484,0.174,0.775,0.056,0.497,0.171,0.562,0.203,0.562,0.292,0.844,0.287,0.83,0.633,0.635,0.618,0.636,0.563,0.646,0.665,0.741,0.961,0.614,0.886,0.762,0.793,0.465,0.753,0.599,0.649,0.751,0.761,0.585,0.825,0.416,0.479,0.425,0.511,0.243,0.46,0.453,0.393,0.463,0.454,0.532,0.204,0.394,0.437,0.147,0.141,0.512,0.149,0.289,0.463,0.467,0.248,0.341,0.522,0.155,0.14,0.604,0.487,0.384,0.837,0.507,0.636,0.522,0.789,0.48,0.575,0.645,0.613,0.69,0.905,0.822,0.668,0.813,0.57,0.867,0.603,0.681,0.754,0.706,0.671,0.847,0.582,0.744,0.662,0.315,0.58,0.328,0.539,0.356,0.586,0.438,0.633,0.511,0.395,0.4,0.278,0.394,0.227,0.539,0.336,0.512,0.555,0.388,0.569,0.31,0.393,0.46,0.351,0.463,0.634,0.568,0.666,0.744,0.626,0.641,0.664,0.676,0.656,0.758,0.854,0.725,0.744,0.867,0.877,0.72,0.601,0.787,0.642,0.654,0.815,0.627,0.734,0.788,0.656,0.62,0.512,0.49,0.496,0.484,0.422,0.467,0.411,0.444,0.37,0.412,0.37,0.331,0.286,0.308,0.325,0.348,0.355,0.362,0.374,0.421,0.405,0.326,0.412,0.408,0.446,0.45,0.558,0.584,0.596,0.635,0.656,0.662,0.638,0.702,0.701,0.777,0.824,0.753,0.773,0.817,0.821,0.745,0.748,0.806,0.774,0.769,0.75,0.779,0.786,0.721,0.744,0.659,0.608,0.641,0.618,0.569,0.566,0.534,0.473,0.487,0.436,0.411,0.388,0.408,0.413,0.388,0.392,0.409,0.396,0.366,0.397,0.438,0.407,0.413,0.394,0.434,0.44,0.47,0.503,0.517,0.548,0.554,0.599,0.628,0.64,0.63,0.677,0.652,0.667,0.724,0.7,0.688,0.704,0.723,0.761,0.751,0.766,0.77,0.741,0.712,0.711,0.722,0.67,0.623,0.645,0.674,0.671,0.612,0.6,0.592,0.501,0.487,0.499,0.432,0.421,0.451,0.488,0.446,0.425,0.465,0.436,0.4,0.392,0.424,0.416,0.436,0.493,0.476,0.531,0.511,0.554,0.53,0.555,0.577,0.596,0.626,0.684,0.691,0.706,0.719,0.676,0.719,0.702,0.712,0.693,0.771,0.773,0.736,0.758,0.763,0.706,0.741,0.669,0.651,0.671,0.628,0.626,0.641,0.571,0.574,0.539,0.484,0.445,0.421,0.445,0.453,0.449,0.372,0.448,0.432,0.404,0.398,0.396,0.395,0.402,0.441,0.433,0.446,0.416,0.474,0.54,0.524,0.541,0.559,0.577,0.616,0.636,0.667,0.712,0.725,0.72,0.768,0.762,0.764,0.732,0.756,0.747,0.793,0.75,0.788,0.759,0.78,0.762,0.676,0.672,0.662,0.62,0.63,0.689,0.648,0.599,0.551,0.538,0.498,0.447,0.457,0.386,0.382,0.377,0.384,0.374,0.381,0.41,0.361,0.342,0.392,0.36,0.358,0.41,0.437,0.416,0.427,0.446,0.524,0.504,0.537,0.565,0.58,0.596,0.668,0.703,0.715,0.763,0.739,0.726,0.714,0.785,0.776,0.744,0.766,0.793,0.802,0.774,0.788,0.785,0.733,0.701,0.694,0.671,0.676,0.632,0.641,0.617,0.598,0.595,0.54,0.505,0.457,0.446,0.398,0.406,0.445,0.434,0.421,0.394,0.388,0.383,0.378,0.346,0.386,0.387,0.452,0.464,0.461,0.472,0.498,0.521,0.51};
    double processedSignal[N];
    
    double mean;
    double sum = 0.0;
    for (int i = 0; i < N; i++) {
        sum += rawSignal[i];
    }
    printf("Sum of Data is : %f\n", sum);
    mean = sum / N;
    double mean_1= sum / N;
    printf("Mean of Data is : %f\n", mean);
    for (int i = 0; i < N; i++) {
        processedSignal[i] = fabs(rawSignal[i] - mean);
        printf("%lf,", processedSignal[i]);
    }
    printf("\n");

    printf("Delta \n");
     double delta[N];
     int binCount=0;
    for (int b = 0; b < B; b++) {
        //double binSum = 0.0;
        binCount++;
        printf("Derivative(Delta) of Bin %d: \n" , binCount);
        
        for (int i = 1; i < L; i++) {
            delta[i] = processedSignal[(b * L) + i] - processedSignal[(b * L) + (i - 1)];
            printf("%lf,", delta[i]);
            //binSum += fabs(delta[i]);
        }
        
        printf("\n");
        // printf("Bin_Sum of Data is : %f\n", binSum);
       // double meanDelta = binSum / (L - 1);
        //printf("Mean Derivative of Bin Data is : %f\n", meanDelta);
        //if (meanDelta > THRESHOLD) {
            int localMaximaCount = 0;
            for (int i = 1; i < L - 1; i++) {
                if (processedSignal[(b * L ) + i] > processedSignal[(b * L ) + (i - 1)] &&
                    processedSignal[(b * L ) + i] > processedSignal[(b * L ) + (i + 1)]) {
                    localMaximaCount++;
                    printf("Peak found at position %d, magnitude: %lf\n", (b * L) + i, processedSignal[(b * L) + i]);
                }
                if (localMaximaCount >= P) {
                    break; // Found enough peaks in this bin
                }
            }
//}
    }
}

int main() {
    
    
    Bin_Based_Accel();


    return 0;
}
